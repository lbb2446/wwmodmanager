# 业务需求文档
版本: 0.1.0
日期: 2026-02-19

摘要
- 基于现有代码库，将现有功能整理为可追踪的需求文档，后续以此驱动开发、测试和验收。

1. 项目背景
- 现有 MOD 管理器应用为 Flask + 简单前端架构，具备角色、MOD 管理、同步、预览、关机等能力。
2. 目标
- 建立可迭代的需求文档，明确功能边界、接口契约、数据模型与非功能性需求。
3. 作用范围
- 面向 MOD 管理器的前后端能力，覆盖角色同步、MOD 开关、预览、以及关机清理等核心流程。

- 之间的空行保持通用性。

2. 需求总览
- 通用系统功能
  - 关闭窗口时，需要关闭整个系统
- 角色管理
  - 角色来源：库洛第三方接口
  - 角色同步：/api/sync_chars，拉取并本地化存储
  - 角色信息：名称、头像路径、MOD 数量
- 角色详情与状态
  - 启动后对角色目录中的 MOD 前缀进行状态表示（如 DISABLED_ 前缀表示禁用）
  - 启动时对本地目录状态进行对齐与修正
- MOD 管理
  - MOD 启用/禁用（单个、全部）
  - 启用一个 MOD 时，自动禁用同一角色下的其他 MOD
  - 禁用/启用全部的批处理能力
- 预览
  - 提供 mod 预览图片接口 /api/preview
- 资源与路径
  - 动态获取 MOD 根目录、角色图片目录、资源目录

3. 接口契约（简要）
- /api/shutdown: POST，参数 confirm=True 时关闭服务器
- /api/sync_chars: POST，外部接口数据拉取并写入本地
- /api/chars: GET，返回角色列表，包含名称、image_url、mod_count
- /api/get_mods: GET，参数 char，返回该角色下的 MOD 列表
- /api/preview: GET，参数 char、mod，返回该 mod 的预览图片
- /api/toggle: POST，参数 char、mod、action（enable/disable/enable_all/disable_all）

4. 数据模型
- Char
  - name: 角色名称
  - image_url: 角色头像 URL（若存在本地图片则返回网址）
  - mod_count: 角色下 MOD 的数量
- Mod
  - name: MOD 名称（含 DISABLED_ 前缀时表示禁用）
  - disabled: 是否禁用
  - preview_url: 预览图片 URL（如果存在）

5. 约束与非功能性需求
- 可靠性：对外部接口调用加入超时与异常处理
- 安全性：输入校验，避免路径注入和越权访问
- 兼容性：支持开发模式与生产模式的行为差异
- 日志与监控：关键操作记录日志，便于问题排查
- 性能：图片下载和缓存对用户体验友好

6. 验收标准
- 关闭窗口时应用能够优雅关闭并释放资源
- /api/sync_chars 能正确拉取并创建/更新本地角色目录与头像
- /api/chars 返回的角色列表正确、且 mod_count 与实际文件夹数量一致
- 启用一个 MOD 时，其他 MOD 自动禁用，且仅有一个 MOD 处于启用状态
- /api/preview 能返回有效图片或 404（如无预览图）
- /api/shutdown 在确认后能返回关闭状态
- 变更日志与需求文档保持同步

7. 变更与版本控制
- 每次实现新需求时更新版本号和变更记录
- 提交前对照需求点完成情况，确保验收标准可追溯

8. 术语表
- DISABLED_<MOD>：MOD 的禁用状态前缀
- MOD：模块，角色下的一个资源集合
- CHAR：角色
