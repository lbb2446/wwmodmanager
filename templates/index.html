<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mod Manager</title>
    <style>
        :root {
            --bg: #1a1b26;
            --surface: #24283b;
            --surface-hover: #2d3142;
            --text: #c0caf5;
            --text-dim: #7aa2f7;
            --accent: #7dcfff;
            --green: #9ece6a;
            --red: #f7768e;
            --radius: 10px;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        #sidebar {
            width: 260px;
            background: var(--surface);
            border-right: 1px solid rgba(255,255,255,.06);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #sidebar h1 {
            font-size: 1rem;
            padding: 16px;
            margin: 0;
            color: var(--accent);
            border-bottom: 1px solid rgba(255,255,255,.06);
        }
        #syncWrap {
            padding: 12px 16px;
        }
        #syncBtn {
            width: 100%;
            padding: 10px 16px;
            background: var(--accent);
            color: var(--bg);
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        #syncBtn:hover { filter: brightness(1.1); }
        #syncBtn:disabled { opacity: 0.7; cursor: not-allowed; }
        #folderActions {
            padding: 12px 16px;
            border-top: 1px solid rgba(255,255,255,.06);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .folder-btn {
            width: 100%;
            padding: 8px 16px;
            background: var(--surface-hover);
            color: var(--text);
            border: 1px solid rgba(255,255,255,.1);
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            font-size: 13px;
        }
        .folder-btn:hover { filter: brightness(1.1); background: var(--accent); color: var(--bg); }
        #shutdownWrap {
            padding: 12px 16px;
            border-top: 1px solid rgba(255,255,255,.06);
        }
        #shutdownBtn {
            width: 100%;
            padding: 8px 16px;
            background: var(--red);
            color: #fff;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
        }
        #shutdownBtn:hover { filter: brightness(1.1); }
        #shutdownBtn:disabled { opacity: 0.7; cursor: not-allowed; }
        #charList {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .char-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background .15s;
        }
        .char-item:hover { background: var(--surface-hover); }
        .char-item.active { background: rgba(125, 207, 255, .2); }
        .char-item img {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
            background: var(--bg);
        }
        .char-item .no-img {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--surface-hover);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-dim);
        }
        .char-item .name { font-weight: 500; flex: 1; min-width: 0; }
        .char-item .mod-count {
            font-size: 12px;
            color: var(--text-dim);
            margin-left: 6px;
            flex-shrink: 0;
        }

        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #mainHead {
            padding: 16px 24px;
            border-bottom: 1px solid rgba(255,255,255,.06);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }
        #currentChar {
            margin: 0;
            font-size: 1.25rem;
            color: var(--accent);
        }
        #batchActions {
            display: none;
            gap: 8px;
        }
        #batchActions button {
            padding: 8px 14px;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }
        #batchActions .btn-enable { background: var(--green); color: var(--bg); }
        #batchActions .btn-disable { background: var(--red); color: #fff; }
        #batchActions button:hover { filter: brightness(1.1); }

        #modList {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            align-content: start;
        }
        .mod-card {
            background: var(--surface);
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,.06);
            transition: border-color .15s;
        }
        .mod-card:hover { border-color: rgba(125, 207, 255, .3); }
        .mod-card.disabled { opacity: 0.65; }
        .mod-card .preview-wrap {
            width: 100%;
            height: 140px;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .mod-card .preview-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .mod-card .preview-wrap .placeholder {
            color: var(--text-dim);
            font-size: 13px;
        }
        .mod-card .info {
            padding: 12px;
        }
        .mod-card .clean-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .mod-card .status-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-dot.on { background: var(--green); }
        .status-dot.off { background: var(--red); }
        .mod-card .toggle-btn {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }
        .mod-card .toggle-btn.enable { background: var(--green); color: var(--bg); }
        .mod-card .toggle-btn.disable { background: var(--red); color: #fff; }
        .mod-card .toggle-btn:hover { filter: brightness(1.1); }

        #emptyState {
            padding: 48px 24px;
            text-align: center;
            color: var(--text-dim);
        }
        #emptyState p { margin: 8px 0; }
    </style>
</head>
<body>

<div id="sidebar">
    <h1>Mod Manager</h1>
    <div id="syncWrap">
        <button id="syncBtn" type="button" onclick="syncChars()">Sync Characters</button>
    </div>
    <div id="folderActions">
        <button class="folder-btn" type="button" onclick="openModsFolder()">Open Mods Folder</button>
        <button class="folder-btn" type="button" onclick="openExeFolder()">Open App Folder</button>
    </div>
    <div id="charList"></div>
    <div id="shutdownWrap">
        <button id="shutdownBtn" type="button" onclick="shutdownApp()">Close App</button>
    </div>
</div>

<div id="main">
    <div id="mainHead">
        <h2 id="currentChar">Select a character</h2>
        <div id="batchActions" class="batch-actions">
            <button type="button" class="btn-enable" onclick="batchToggle('enable_all')">Enable All</button>
            <button type="button" class="btn-disable" onclick="batchToggle('disable_all')">Disable All</button>
        </div>
    </div>
    <div id="modList"></div>
    <div id="emptyState" style="display:none;">
        <p>No mods for this character.</p>
        <p>Place mod folders in the character directory, or click "Sync Characters" first.</p>
    </div>
</div>

<script>
    let selectedChar = null;

    document.addEventListener('DOMContentLoaded', loadChars);

    async function loadChars() {
        const listEl = document.getElementById('charList');
        try {
            const res = await fetch('/api/chars');
            const chars = await res.json();
            listEl.innerHTML = '';
            if (chars.length === 0) {
                listEl.innerHTML = '<p style="padding:12px;color:var(--text-dim);font-size:13px;">No characters. Click "Sync Characters" first.</p>';
                return;
            }
            chars.forEach(function (c) {
                const div = document.createElement('div');
                div.className = 'char-item';
                div.dataset.name = c.name;
                div.innerHTML = c.image_url
                    ? '<img src="' + c.image_url + '" alt="">'
                    : '<div class="no-img">?</div>';
                div.innerHTML += '<span class="name">' + escapeHtml(c.name) + '</span>';
                div.innerHTML += '<span class="mod-count">' + (c.mod_count != null ? c.mod_count : 0) + '</span>';
                div.onclick = function () { loadMods(c.name); };
                listEl.appendChild(div);
            });
        } catch (e) {
            listEl.innerHTML = '<p style="padding:12px;color:var(--red);">Load failed</p>';
        }
    }

    function setActiveChar(name) {
        document.querySelectorAll('.char-item').forEach(function (el) {
            el.classList.toggle('active', el.dataset.name === name);
        });
    }

    async function syncChars() {
        const btn = document.getElementById('syncBtn');
        btn.disabled = true;
        btn.textContent = 'Syncing...';
        try {
            const res = await fetch('/api/sync_chars', { method: 'POST' });
            const text = await res.text();
            let data;
            try {
                data = JSON.parse(text);
            } catch (_) {
                alert('Server error: ' + (res.ok ? 'Invalid JSON' : 'HTTP ' + res.status));
                return;
            }
            if (data.status === 'success') {
                await loadChars();
                alert('Sync complete: ' + data.count + ' characters');
            } else {
                alert('Sync failed: ' + (data.message || 'Unknown error'));
            }
        } catch (e) {
            alert('Request failed: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Sync Characters';
        }
    }

    async function loadMods(charName) {
        selectedChar = charName;
        document.getElementById('currentChar').textContent = charName;
        document.getElementById('batchActions').style.display = 'flex';
        document.getElementById('emptyState').style.display = 'none';
        setActiveChar(charName);

        const container = document.getElementById('modList');
        container.innerHTML = '<p style="color:var(--text-dim);">Loading...</p>';
        try {
            const res = await fetch('/api/get_mods?char=' + encodeURIComponent(charName));
            const mods = await res.json();
            container.innerHTML = '';
            if (mods.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            mods.forEach(function (mod) {
                const card = document.createElement('div');
                card.className = 'mod-card' + (mod.disabled ? ' disabled' : '');
                const action = mod.disabled ? 'enable' : 'disable';
                const btnClass = mod.disabled ? 'enable' : 'disable';
                const btnText = mod.disabled ? 'Enable' : 'Disable';
                const previewHtml = mod.preview_url
                    ? '<img src="' + mod.preview_url + '" alt="" loading="lazy">'
                    : '<span class="placeholder">No preview</span>';
                card.innerHTML =
                    '<div class="preview-wrap">' + previewHtml + '</div>' +
                    '<div class="info">' +
                    '<div class="clean-name">' + escapeHtml(mod.clean_name) + '</div>' +
                    '<div class="status-row">' +
                    '<span><span class="status-dot ' + (mod.disabled ? 'off' : 'on') + '"></span>' + (mod.disabled ? 'Disabled' : 'Enabled') + '</span>' +
                    '</div>' +
                    '<button type="button" class="toggle-btn ' + btnClass + '" data-path="' + escapeHtml(mod.path) + '" data-action="' + action + '">' + btnText + '</button>' +
                    '</div>';
                card.querySelector('.toggle-btn').onclick = function () {
                    toggleMod(this.dataset.path, this.dataset.action);
                };
                container.appendChild(card);
            });
        } catch (e) {
            container.innerHTML = '<p style="color:var(--red);">Load failed</p>';
        }
    }

    function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    async function toggleMod(modPath, action) {
        if (!selectedChar) return;
        try {
            const res = await fetch('/api/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ char: selectedChar, mod: modPath, action: action })
            });
            const data = await res.json();
            if (data.status === 'success') {
                loadMods(selectedChar);
            } else {
                alert(data.message || 'Operation failed');
            }
        } catch (e) {
            alert('Request failed: ' + e.message);
        }
    }

    async function batchToggle(action) {
        if (!selectedChar) return;
        if (!confirm(action === 'enable_all' ? 'Enable all mods?' : 'Disable all mods?')) return;
        try {
            const res = await fetch('/api/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ char: selectedChar, mod: '', action: action })
            });
            const data = await res.json();
            if (data.status === 'success') {
                loadMods(selectedChar);
            } else {
                alert(data.message || 'Operation failed');
            }
        } catch (e) {
            alert('Request failed: ' + e.message);
        }
    }

    async function shutdownApp() {
        if (!confirm('Close Mod Manager?\n\nUnsaved changes will be lost.')) return;
        
        const btn = document.getElementById('shutdownBtn');
        btn.disabled = true;
        btn.textContent = 'Closing...';
        
        try {
            const res = await fetch('/api/shutdown', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ confirm: true })
            });
            const data = await res.json();
            
            if (data.status === 'shutting_down') {
                alert('Closing application...');
                setTimeout(function() {
                    window.close();
                }, 1000);
            } else {
                alert('Close failed: ' + (data.message || 'Unknown error'));
                btn.disabled = false;
                btn.textContent = 'Close App';
            }
        } catch (e) {
            alert('Request failed: ' + e.message);
            btn.disabled = false;
            btn.textContent = 'Close App';
        }
    }

    async function openExeFolder() {
        try {
            const res = await fetch('/api/open_exe_folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            const data = await res.json();
            if (data.status !== 'success') {
                alert('Failed to open folder: ' + (data.message || 'Unknown error'));
            }
        } catch (e) {
            alert('Request failed: ' + e.message);
        }
    }

    async function openModsFolder() {
        try {
            const res = await fetch('/api/open_mods_folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            const data = await res.json();
            if (data.status !== 'success') {
                alert('Failed to open folder: ' + (data.message || 'Unknown error'));
            }
        } catch (e) {
            alert('Request failed: ' + e.message);
        }
    }
</script>
</body>
</html>
