<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mod Manager</title>
    <style>
        :root {
            --bg: #1a1b26;
            --surface: #24283b;
            --surface-hover: #2d3142;
            --text: #c0caf5;
            --text-dim: #7aa2f7;
            --accent: #7dcfff;
            --green: #9ece6a;
            --red: #f7768e;
            --radius: 10px;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        #sidebar {
            width: 260px;
            background: var(--surface);
            border-right: 1px solid rgba(255,255,255,.06);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #sidebar h1 {
            font-size: 1rem;
            padding: 16px;
            margin: 0;
            color: var(--accent);
            border-bottom: 1px solid rgba(255,255,255,.06);
        }
        #syncWrap {
            padding: 12px 16px;
        }
        #syncBtn {
            width: 100%;
            padding: 10px 16px;
            background: var(--accent);
            color: var(--bg);
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        #syncBtn:hover { filter: brightness(1.1); }
        #syncBtn:disabled { opacity: 0.7; cursor: not-allowed; }
        #folderActions {
            padding: 12px 16px;
            border-top: 1px solid rgba(255,255,255,.06);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .folder-btn {
            width: 100%;
            padding: 8px 16px;
            background: var(--surface-hover);
            color: var(--text);
            border: 1px solid rgba(255,255,255,.1);
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            font-size: 13px;
        }
        .folder-btn:hover { filter: brightness(1.1); background: var(--accent); color: var(--bg); }
        #shutdownWrap {
            padding: 12px 16px;
            border-top: 1px solid rgba(255,255,255,.06);
        }
        #shutdownBtn {
            width: 100%;
            padding: 8px 16px;
            background: var(--red);
            color: #fff;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
        }
        #shutdownBtn:hover { filter: brightness(1.1); }
        #shutdownBtn:disabled { opacity: 0.7; cursor: not-allowed; }
        #charList {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .char-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background .15s;
        }
        .char-item:hover { background: var(--surface-hover); }
        .char-item.active { background: rgba(125, 207, 255, .2); }
        .char-item img {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
            background: var(--bg);
        }
        .char-item .no-img {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--surface-hover);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-dim);
        }
        .char-item .name { font-weight: 500; flex: 1; min-width: 0; }
        .char-item .mod-count {
            font-size: 12px;
            color: var(--text-dim);
            margin-left: 6px;
            flex-shrink: 0;
        }

        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #mainHead {
            padding: 16px 24px;
            border-bottom: 1px solid rgba(255,255,255,.06);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }
        #currentChar {
            margin: 0;
            font-size: 1.25rem;
            color: var(--accent);
        }
        #batchActions {
            display: none;
            gap: 8px;
        }
        #batchActions button {
            padding: 8px 14px;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }
        #batchActions .btn-enable { background: var(--green); color: var(--bg); }
        #batchActions .btn-disable { background: var(--red); color: #fff; }
        #batchActions button:hover { filter: brightness(1.1); }

        #modList {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            align-content: start;
        }
        .mod-card {
            background: var(--surface);
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,.06);
            transition: border-color .15s;
        }
        .mod-card:hover { border-color: rgba(125, 207, 255, .3); }
        .mod-card.disabled { opacity: 0.65; }
        .mod-card .preview-wrap {
            width: 100%;
            height: 140px;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .mod-card .preview-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .mod-card .preview-wrap .placeholder {
            color: var(--text-dim);
            font-size: 13px;
        }
        .mod-card .info {
            padding: 12px;
        }
        .mod-card .clean-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .mod-card .status-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-dot.on { background: var(--green); }
        .status-dot.off { background: var(--red); }
        .mod-card .toggle-btn {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }
        .mod-card .toggle-btn.enable { background: var(--green); color: var(--bg); }
        .mod-card .toggle-btn.disable { background: var(--red); color: #fff; }
        .mod-card .toggle-btn:hover { filter: brightness(1.1); }

        #emptyState {
            padding: 48px 24px;
            text-align: center;
            color: var(--text-dim);
        }
        #emptyState p { margin: 8px 0; }
    </style>
</head>
<body>

<div id="sidebar">
    <h1>Mod Manager</h1>
    <div id="syncWrap">
        <button id="syncBtn" type="button" onclick="syncChars()">&#21516;&#27493;&#35268;&#21017;</button>
    </div>
    <div id="folderActions">
        <button class="folder-btn" type="button" onclick="openModsFolder()">&#25171;&#24320;Mod&#25991;&#20214;&#22841;</button>
        <button class="folder-btn" type="button" onclick="openExeFolder()">&#25171;&#24320;&#24212;&#29992;&#25991;&#20214;&#22841;</button>
    </div>
    <div id="charList"></div>
    <div id="shutdownWrap">
        <button id="shutdownBtn" type="button" onclick="shutdownApp()">&#20851;&#38381;&#24212;&#29992;</button>
    </div>
</div>

<div id="main">
    <div id="mainHead">
        <h2 id="currentChar">&#35831;&#36873;&#25321;&#24038;&#20391;&#35268;&#21017;</h2>
        <div id="batchActions" class="batch-actions">
            <button type="button" class="btn-enable" onclick="batchToggle('enable_all')">&#20840;&#37096;&#21551;&#29992;</button>
            <button type="button" class="btn-disable" onclick="batchToggle('disable_all')">&#20840;&#37096;&#31105;&#29992;</button>
        </div>
    </div>
    <div id="modList"></div>
    <div id="emptyState" style="display:none;">
        <p>&#35813;&#35268;&#21017;&#19979;&#26242;&#26087;Mod&#65292;&#25110;&#26410;&#36873;&#25321;&#35268;&#21017;&#12290;</p>
        <p>&#21487;&#23558;Mod&#25991;&#20214;&#22841;&#25918;&#20837;&#23545;&#24212;&#35268;&#21017;&#30446;&#24405;&#65292;&#25110;&#20808;&#28857;&#20987;&#12300;&#21516;&#27493;&#35268;&#21017;&#12301;&#20174;&#25509;&#21475;&#25209;&#21462;&#35268;&#21017;&#21015;&#34920;&#12290;</p>
    </div>
</div>

<script>
    var selectedChar = null;

    document.addEventListener('DOMContentLoaded', loadChars);

    function loadChars() {
        var listEl = document.getElementById('charList');
        fetch('/api/chars').then(function(res) { return res.json(); }).then(function(chars) {
            listEl.innerHTML = '';
            if (chars.length === 0) {
                listEl.innerHTML = '<p style="padding:12px;color:var(--text-dim);font-size:13px;">&#26242;&#26087;&#35268;&#21017;&#65292;&#35831;&#20808;&#28857;&#20987;&#12300;&#21516;&#27493;&#35268;&#21017;&#12301;</p>';
                return;
            }
            chars.forEach(function (c) {
                var div = document.createElement('div');
                div.className = 'char-item';
                div.dataset.name = c.name;
                div.innerHTML = c.image_url
                    ? '<img src="' + c.image_url + '" alt="">'
                    : '<div class="no-img">?</div>';
                div.innerHTML += '<span class="name">' + escapeHtml(c.name) + '</span>';
                div.innerHTML += '<span class="mod-count">' + (c.mod_count != null ? c.mod_count : 0) + '</span>';
                div.onclick = function () { loadMods(c.name); };
                listEl.appendChild(div);
            });
        }).catch(function(e) {
            listEl.innerHTML = '<p style="padding:12px;color:var(--red);">&#21152;&#36733;&#22833;&#36133;</p>';
        });
    }

    function setActiveChar(name) {
        document.querySelectorAll('.char-item').forEach(function (el) {
            el.classList.toggle('active', el.dataset.name === name);
        });
    }

    function syncChars() {
        var btn = document.getElementById('syncBtn');
        btn.disabled = true;
        btn.textContent = '\u540c\u6b65\u4e2d...';
        fetch('/api/sync_chars', { method: 'POST' }).then(function(res) { return res.text(); }).then(function(text) {
            var data;
            try { data = JSON.parse(text); } catch (_) {
                alert('\u670d\u52a1\u5668\u8fd4\u5f02\u5e38');
                btn.disabled = false;
                btn.textContent = '\u540c\u6b65\u89c4\u5219';
                return;
            }
            if (data.status === 'success') {
                loadChars();
                alert('\u540c\u6b65\u5b8c\u6210\uff0c\u5171 ' + data.count + ' \u4e2a\u89c4\u5219');
            } else {
                alert('\u540c\u6b65\u5931\u8d25\uff1a' + (data.message || '\u672a\u77e5\u9519\u8bef'));
            }
            btn.disabled = false;
            btn.textContent = '\u540c\u6b65\u89c4\u5219';
        }).catch(function(e) {
            alert('\u8bf7\u6c42\u5931\u8d25\uff1a' + e.message);
            btn.disabled = false;
            btn.textContent = '\u540c\u6b65\u89c4\u5219';
        });
    }

    function loadMods(charName) {
        selectedChar = charName;
        document.getElementById('currentChar').textContent = charName;
        document.getElementById('batchActions').style.display = 'flex';
        document.getElementById('emptyState').style.display = 'none';
        setActiveChar(charName);

        var container = document.getElementById('modList');
        container.innerHTML = '<p style="color:var(--text-dim);">\u52a0\u8f7d\u4e2d...</p>';
        fetch('/api/get_mods?char=' + encodeURIComponent(charName)).then(function(res) { return res.json(); }).then(function(mods) {
            container.innerHTML = '';
            if (mods.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            mods.forEach(function (mod) {
                var card = document.createElement('div');
                card.className = 'mod-card' + (mod.disabled ? ' disabled' : '');
                var action = mod.disabled ? 'enable' : 'disable';
                var btnClass = mod.disabled ? 'enable' : 'disable';
                var btnText = mod.disabled ? '\u542f\u7528' : '\u7981\u7528';
                var previewHtml = mod.preview_url
                    ? '<img src="' + mod.preview_url + '" alt="" loading="lazy">'
                    : '<span class="placeholder">\u65e0\u9884\u89c6\u56fe</span>';
                card.innerHTML =
                    '<div class="preview-wrap">' + previewHtml + '</div>' +
                    '<div class="info">' +
                    '<div class="clean-name">' + escapeHtml(mod.clean_name) + '</div>' +
                    '<div class="status-row">' +
                    '<span><span class="status-dot ' + (mod.disabled ? 'off' : 'on') + '"></span>' + (mod.disabled ? '\u672a\u542f\u7528' : '\u5df2\u542f\u7528') + '</span>' +
                    '</div>' +
                    '<button type="button" class="toggle-btn ' + btnClass + '" data-path="' + escapeHtml(mod.path) + '" data-action="' + action + '">' + btnText + '</button>' +
                    '</div>';
                card.querySelector('.toggle-btn').onclick = function () {
                    toggleMod(this.dataset.path, this.dataset.action);
                };
                container.appendChild(card);
            });
        }).catch(function(e) {
            container.innerHTML = '<p style="color:var(--red);">\u52a0\u8f7d\u5931\u8d25</p>';
        });
    }

    function escapeHtml(s) {
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    function toggleMod(modPath, action) {
        if (!selectedChar) return;
        fetch('/api/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ char: selectedChar, mod: modPath, action: action })
        }).then(function(res) { return res.json(); }).then(function(data) {
            if (data.status === 'success') {
                loadMods(selectedChar);
            } else {
                alert(data.message || '\u64cd\u4f5c\u5931\u8d25');
            }
        }).catch(function(e) {
            alert('\u8bf7\u6c42\u5931\u8d25\uff1a' + e.message);
        });
    }

    function batchToggle(action) {
        if (!selectedChar) return;
        if (!confirm(action === 'enable_all' ? '\u786e\u5b9a\u5168\u90e8\u542f\u7528\uff1f' : '\u786e\u5b9a\u5168\u90e8\u7981\u7528\uff1f')) return;
        fetch('/api/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ char: selectedChar, mod: '', action: action })
        }).then(function(res) { return res.json(); }).then(function(data) {
            if (data.status === 'success') {
                loadMods(selectedChar);
            } else {
                alert(data.message || '\u64cd\u4f5c\u5931\u8d25');
            }
        }).catch(function(e) {
            alert('\u8bf7\u6c42\u5931\u8d25\uff1a' + e.message);
        });
    }

    function shutdownApp() {
        if (!confirm('\u786e\u5b9a\u8981\u5173\u95ed Mod \u7ba1\u7406\u5668\u5417\uff1f\n\n\u6240\u6709\u672a\u4fdd\u5b58\u7684\u64cd\u4f5c\u5c06\u4e22\u5931\u3002')) return;
        
        var btn = document.getElementById('shutdownBtn');
        btn.disabled = true;
        btn.textContent = '\u5173\u95ed\u4e2d...';
        
        fetch('/api/shutdown', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ confirm: true })
        }).then(function(res) { return res.json(); }).then(function(data) {
            if (data.status === 'shutting_down') {
                alert('\u5e94\u7528\u6b63\u5728\u5173\u95ed...');
                setTimeout(function() {
                    window.close();
                }, 1000);
            } else {
                alert('\u5173\u95ed\u5931\u8d25\uff1a' + (data.message || '\u672a\u77e5\u9519\u8bef'));
                btn.disabled = false;
                btn.textContent = '\u5173\u95ed\u5e94\u7528';
            }
        }).catch(function(e) {
            alert('\u8bf7\u6c42\u5931\u8d25\uff1a' + e.message);
            btn.disabled = false;
            btn.textContent = '\u5173\u95ed\u5e94\u7528';
        });
    }

    function openExeFolder() {
        fetch('/api/open_exe_folder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        }).then(function(res) { return res.json(); }).then(function(data) {
            if (data.status !== 'success') {
                alert('\u6253\u5f00\u6587\u4ef6\u5939\u5931\u8d25\uff1a' + (data.message || '\u672a\u77e5\u9519\u8bef'));
            }
        }).catch(function(e) {
            alert('\u8bf7\u6c42\u5931\u8d25\uff1a' + e.message);
        });
    }

    function openModsFolder() {
        fetch('/api/open_mods_folder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        }).then(function(res) { return res.json(); }).then(function(data) {
            if (data.status !== 'success') {
                alert('\u6253\u5f00\u6587\u4ef6\u5939\u5931\u8d25\uff1a' + (data.message || '\u672a\u77e5\u9519\u8bef'));
            }
        }).catch(function(e) {
            alert('\u8bf7\u6c42\u5931\u8d25\uff1a' + e.message);
        });
    }
</script>
</body>
</html>
